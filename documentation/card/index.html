<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Card - CRAZYFOX</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css">

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">CRAZYFOX</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../.." class="nav-link">功能预览</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">快速接入 <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../quik/" class="dropdown-item">1. SDK API</a>
</li>
                                    
<li>
    <a href="../bluetooth/" class="dropdown-item">2. BLUETOOTH API</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">交互流程图 <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../flowChart/overview/" class="dropdown-item">概述和序列图</a>
</li>
                                    
<li>
    <a href="../../flowChart/systemFlowChart/" class="dropdown-item">系统交互图</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">交易类型和应答码 <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../attached/sdkAnserCode/" class="dropdown-item">1. 应答码表:sdk应答码表</a>
</li>
                                    
<li>
    <a href="../../attached/symbol/" class="dropdown-item">2. 交易处理标志和冲正标志</a>
</li>
                                    
<li>
    <a href="../../attached/ticket/" class="dropdown-item">3. 签购单规范</a>
</li>
                                    
<li>
    <a href="../../attached/transType/" class="dropdown-item">4. 交易类型</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">sdk环境与版本说明 <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../download/" class="dropdown-item">版本说明与sample下载</a>
</li>
                                    
<li>
    <a href="../../about/" class="dropdown-item">环境地址</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a href="https://github.com/CardInfoLink/Smart-POS/edit/master/docs/documentation/card.md" class="nav-link"><i class="fa fa-github"></i> Edit on GitHub</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<p><strong>a、银行卡交易</strong></p>
<p>由于银行卡交易逻辑有点复杂,讯联提供了一个 <code>BaseCardActivity</code> 基础类,你只需要继承这个类便可以做银行卡类的交易了。具体使用方法可以见 demo 
里的 <code>CommonCardHandlerActivity</code> 类。下面给个大概说明:</p>
<pre><code class="language-java">    public class CommonCardHandlerActivity extends BaseCardActivity {
        @Override
        protected void onCreate(Bundle savedInstanceState) {
            super.onCreate(savedInstanceState);

            //...

        }

        /**
         * 必须传入金额
         *
         * @return
         */
        public String getAmount() {
            //在这里传入金额
        }


        /**
         * 此方法为控制sdk内部是否开启DCC交易逻辑（sdk2.4.1版本及以上支持该方法）
         * 
         *@return 需要进行DCC交易时，返回true，否则返回false
         */
        public boolean isOpenDcc() {
            //只有刷卡消费和刷卡预授权才支持DCC交易
            //如果接入方无需支持DCC，则此方法返回false即可
            return false;
        }


        /**
         * 读卡的结果（sdk2.4.1版本及以上新增RateInfo参数，返回DCC读卡流程中进行汇率查询的结果）
         *
         * @param isSuccess 是否成功
         * @param cardType  卡片种类(-1(unknow) 1(msc) 2(ic) 3(nfc) 4(scancode) 5(other))
         * @param cardInfo  读取卡片信息
         * @param rateInfo  汇率信息
         */
        public void cardReaderHandler(boolean isSuccess, @CardType.Type int cardType, CardInfo cardInfo, RateInfo rateInfo){    
            //读卡成功后才发起交易
            if (!isSuccess || cardInfo == null) {
                Toast.makeText(getApplicationContext(), &quot;读卡失败&quot;,  Toast.LENGTH_SHORT).show();
                initCardEvent();
                return;
            }

            //1. 根据银联85号文规定，智能终端需上送经度，纬度，坐标系信息到卡组织
            CILRequest request = new CILRequest();

            request.setLongitude(121.600228);//设置经度
            request.setLatitude(31.180606);//设置纬度
            request.setCoordinates(&quot;GCJ02&quot;);//设置坐标系
            //关于坐标系，国内一些常用第三方取值：百度（BD09），高德、腾讯（GCJ02），GPS（WGS84）。
            //一般第三方定位SDK都能从定位后返回的位置信息类中取到，详细可查看各第三方接入文档。


            //2.如果接入方需要进行DCC交易，需将汇率信息填入request中，否则无需处理
            CILRequest request = new CILRequest();
            ...
            if (rateInfo != null) {
                request.setBillingAmt(rateInfo.getBillingAmt());//设置扣账金额
                request.setBillingCurr(rateInfo.getBillingCurr());//设置扣账币种
                request.setTransRate(rateInfo.getTransRate());//设置交易汇率
                request.setBatchNum(rateInfo.getBatchNum());//设置汇率请求批次号
                request.setTraceNum(rateInfo.getTraceNum());//设置汇率请求流水号
            }

            //3. 在这里面发送银行卡相关的交易(如消费、消费撤销、退货、预授权、预授权撤销、预授权完成、预授权完成撤销、余额查询)
            //CILSDK.consume(request, cardType, new Callback&lt;CILResponse&gt;() //消费
        }

        /**
         * 显示读卡时的缓冲页面
         */
        public void waitLoadingShow(){

        }

        /**
         * 取消读卡时的缓冲页面
         */
        public void waitLoadingDismiss(){

        }

        /**
         * 读卡失败
         */
        public void cardHandlerError(Exception e){

        }

    }
</code></pre>
<p><span id="base_request" style="font-size:20px;color:red" >注意:</span><br/></p>
<blockquote>
<p>调用银行卡类交易接口时，需要传入CILRequest以及CardType，且所有接口中CILRequest均需要传入以下信息：</p>
</blockquote>
<pre><code>   /**
    * @param: request:请求信息
    * @param: cardType:卡片类型
    */
    request.setAmount(amount);//消费金额
    /**
    * 刷卡获取的cardInfo信息
    */
    request.setCardNumb(cardInfo.getCardNumber());//卡号
    request.setCardExpirationDate(cardInfo.getCardExpirationDate());//卡片有效期
    request.setPinEmv(cardInfo.getPinBins());//卡bin
    request.setCardSequenceNumber(cardInfo.getSequenceSerialNum());//卡片序列号
    request.setField55(cardInfo.getField55());//55域信息
    request.setSecondTrack(cardInfo.getTrack2());//二磁道信息
    request.setOrderId(orderId);//可选参数。（消费、退货、预授权、预授权完成、扫码下单、扫码退货）
    request.setLocation(location)//有终端具备获取位置信息能力时必选上送（ 用于消费 预授权）
</code></pre>
<p><strong>1、消费</strong></p>
<p>消费接口<a href="#base_request">request必须包含参数:</a></p>
<pre><code>    CILSDK.consume(request, cardType, new Callback&lt;CILResponse&gt;() {
            @Override
            public void onResult(CILResponse cilResponse) {
                ...
            }

            @Override
            public void onError(Parcelable cilRequest, Exception e) {
                ...
            }
        });

</code></pre>
<p><strong>2、撤销</strong>
撤销接口<a href="#base_request">request必须包含参数:</a></p>
<pre><code>
    /**
     *  撤销接口除基础信息外，
     *  还需要原交易信息
     */
    request.setReferenceNumber(transaction.getRefNum());//原交易参考号
    request.setRevAuthCode(transaction.getRevAuthCode());//原交易授权码
    request.setBatchNum(transaction.getBatchNum());//原交易批次号
    request.setTraceNum(transaction.getTraceNum());//原交易凭证号

    CILSDK.revokeConsume(request, cardType, new Callback&lt;CILResponse&gt;() {
            @Override
            public void onResult(CILResponse cilResponse) {
                ...
            }

            @Override
            public void onError(Parcelable cilRequest, Exception e) {
                ...
            }
        });

</code></pre>
<p><strong>3、退货</strong>
退货接口<a href="#base_request">request必须包含参数:</a></p>
<pre><code>
    /**
     *  退货接口除基础信息外
     *  还需要原交易信息
     */
    request.setReferenceNumber(referenceNumber);
    request.setTransDatetime(tradeDate);
    CILSDK.returnConsume(request, cardType, new Callback&lt;CILResponse&gt;() {
            @Override
            public void onResult(CILResponse cilResponse) {
                ...
            }

            @Override
            public void onError(Parcelable cilRequest, Exception e) {
                ...
            }
        });

</code></pre>
<p><strong>4、余额查询</strong>
余额查询接口<a href="#base_request">request必须包含参数:</a></p>
<pre><code>    CILSDK.checkBalance(request, cardType, new Callback&lt;CILResponse&gt;() {
            @Override
            public void onResult(CILResponse cilResponse) {
                ...
            }

            @Override
            public void onError(Parcelable cilRequest, Exception e) {
                ...
            }
        });

</code></pre>
<p><strong>5、卡预授权</strong>
预授权接口<a href="#base_request">request必须包含参数:</a></p>
<pre><code>    request.setLocation(location)//有终端具备获取位置信息能力时必选上送（ 用于消费 预授权）
    CILSDK.preAuth(request, cardType, new Callback&lt;CILResponse&gt;() {
            @Override
            public void onResult(CILResponse cilResponse) {
                ...
            }

            @Override
            public void onError(Parcelable cilRequest, Exception e) {
               ...
            }
        });

</code></pre>
<p><strong>6、卡预授权撤销</strong>
预授权撤销接口<a href="#base_request">request必须包含参数:</a></p>
<pre><code>    /**
     *  预授权撤销接口除基础信息外
     *  还需要原预授权交易信息
     */
    request.setRevAuthCode(authCode);//原预授权交易授权码
    request.setTransDatetime(originalTradeDate);//原预授权交易日期
    CILSDK.revokePreAuth(request, cardType, new Callback&lt;CILResponse&gt;() {
            @Override
            public void onResult(CILResponse cilResponse) {
                ...
            }

            @Override
            public void onError(Parcelable cilRequest, Exception e) {
                ...
            }
        });

</code></pre>
<p><strong>7、卡预授权完成</strong>
预授权完成接口<a href="#base_request">request必须包含参数:</a></p>
<pre><code>    /**
     *  预授权完成接口除基础信息外
     *  还需要原预授权交易信息
     */
    request.setRevAuthCode(authCode);//原预授权交易授权码
    request.setTransDatetime(originalTradeDate);//原预授权交易日期
    CILSDK.preAuthComplete(request, cardType, new Callback&lt;CILResponse&gt;() {
            @Override
            public void onResult(CILResponse cilResponse) {
               ...
            }

            @Override
            public void onError(Parcelable cilRequest, Exception e) {
                ...
            }
        });
</code></pre>
<p><strong>8、卡预授权完成撤销</strong>
预授权完成撤销接口<a href="#base_request">request必须包含参数:</a></p>
<pre><code>    /**
     *  预授权完成撤销接口除基础信息外
     *  还需要原预授权完成交易信息
     */
    request.setReferenceNumber(refNum);//原预授权完成交易参考号
    request.setRevAuthCode(authCode);//原预授权完成交易授权码
    request.setTraceNum(traceNum);//原预授权完成交易凭证号
    request.setBatchNum(batchNum);//原预授权完成交易批次号
    request.setTransDatetime(originalTradeDate);//原预授权完成交易日期

    CILSDK.revokePreAuthComplete(request, cardType, new Callback&lt;CILResponse&gt;() {
            @Override
            public void onResult(CILResponse cilResponse) {
                ...
            }

            @Override
            public void onError(Parcelable cilRequest, Exception e) {
                ...
            }
        });
</code></pre>
<p><strong>9、DCC转EDC</strong>  </p>
<p>当交易卡片为外卡时，消费类（消费、预授权完成）交易可选择进行DCC转EDC。</p>
<pre><code>    CILRequest request = new CILRequest();
    request.setCardNum(cardNum);//卡号
    request.setTransDatetime(datetime);//原交易时间
    request.setAmount(amount);//原交易金额
    request.setBillingAmt(biilingAmt);//原扣币金额
    request.setReferenceNumber(refNum);//原交易参考号
    request.setRevAuthCode(revAuthCode);//原交易授权码
    request.setBatchNum(batchNum);//原交易批次号
    request.setTraceNum(traceNum);//原交易凭证号
    request.setTransCurr(transCurr);//原交易币种
    request.setBillingCurr(billingCurr);//原交易扣款币种
    CILSDK.dccToEdc(request, new Callback&lt;CILResponse&gt;() {
        @Override
        public void onResult(CILResponse cilResponse) {
            ...
        }

        @Override
        public void onError(Parcelable p, Exception e) {
            ...
        }
    });

</code></pre>
<p><strong>交易结果字段说明</strong>  </p>
<table>
<thead>
<tr>
<th>字段</th>
<th>类型</th>
<th>含义</th>
<th>备注</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>additionalResData</td>
<td>String</td>
<td>受理方标识码</td>
<td>无</td>
<td></td>
</tr>
<tr>
<td>afterTransCode</td>
<td>String</td>
<td>原交易类型</td>
<td>无</td>
<td></td>
</tr>
<tr>
<td>batchNum</td>
<td>String</td>
<td>批次号</td>
<td>无</td>
<td></td>
</tr>
<tr>
<td>billingAmt</td>
<td>String</td>
<td>持卡人扣帐金额</td>
<td>无</td>
<td></td>
</tr>
<tr>
<td>billingCurr</td>
<td>String</td>
<td>持卡人扣帐货币代码符号，三位字母</td>
<td>例如USD</td>
<td></td>
</tr>
<tr>
<td>billingCurrNum</td>
<td>String</td>
<td>持卡人扣帐货币代码,三位数字</td>
<td>无</td>
<td></td>
</tr>
<tr>
<td>cardBrand</td>
<td>String</td>
<td>国际信用卡公司代码</td>
<td>无</td>
<td></td>
</tr>
<tr>
<td>cardNo</td>
<td>String</td>
<td>银行卡号</td>
<td>无</td>
<td></td>
</tr>
<tr>
<td>cardType</td>
<td>String</td>
<td>刷卡方式</td>
<td>无</td>
<td></td>
</tr>
<tr>
<td>cashierName</td>
<td>String</td>
<td>收银员</td>
<td>无</td>
<td></td>
</tr>
<tr>
<td>cashierNum</td>
<td>String</td>
<td>收银员号</td>
<td>无</td>
<td></td>
</tr>
<tr>
<td>clearingDate</td>
<td>String</td>
<td>清算日期</td>
<td>无</td>
<td></td>
</tr>
<tr>
<td>compInfoA1</td>
<td>String</td>
<td>签购单收单行</td>
<td>无</td>
<td></td>
</tr>
<tr>
<td>compInfoA2</td>
<td>String</td>
<td>签购单商户号</td>
<td>无</td>
<td></td>
</tr>
<tr>
<td>compInfoA3</td>
<td>String</td>
<td>签购单终端号</td>
<td>无</td>
<td></td>
</tr>
<tr>
<td>compInfoA4</td>
<td>String</td>
<td>markup</td>
<td>无</td>
<td></td>
</tr>
<tr>
<td>compInfoA6</td>
<td>String</td>
<td>借贷记标识</td>
<td>无</td>
<td></td>
</tr>
<tr>
<td>compInfoA7</td>
<td>String</td>
<td>营销信息</td>
<td>无</td>
<td></td>
</tr>
<tr>
<td>compInfoA8</td>
<td>String</td>
<td>二维码信息</td>
<td>无</td>
<td></td>
</tr>
<tr>
<td>coupon</td>
<td>String</td>
<td>支付宝/微信优惠金额</td>
<td>无</td>
<td></td>
</tr>
<tr>
<td>field55</td>
<td>String</td>
<td>IC卡交易的TAG信息</td>
<td>无</td>
<td></td>
</tr>
<tr>
<td>insCode</td>
<td>String</td>
<td>受理方标识码</td>
<td>无</td>
<td></td>
</tr>
<tr>
<td>localTransDate</td>
<td>String</td>
<td>受卡方所在地日期</td>
<td>无</td>
<td></td>
</tr>
<tr>
<td>localTransTime</td>
<td>String</td>
<td>受卡方所在地时间</td>
<td>无</td>
<td></td>
</tr>
<tr>
<td>merCode</td>
<td>String</td>
<td>受卡方标识码（商户号）</td>
<td>无</td>
<td></td>
</tr>
<tr>
<td>merDiscount</td>
<td>String</td>
<td>商家优惠金额</td>
<td>无</td>
<td></td>
</tr>
<tr>
<td>originTraceNum</td>
<td>String</td>
<td>原交易凭证号</td>
<td>无</td>
<td></td>
</tr>
<tr>
<td>outOrderNum</td>
<td>String</td>
<td>外部订单号</td>
<td>无</td>
<td></td>
</tr>
<tr>
<td>posInputStyle</td>
<td>String</td>
<td>服务点输入方式码</td>
<td>无</td>
<td></td>
</tr>
<tr>
<td>processflag</td>
<td>String</td>
<td>扫码支付09状态的交易是否成功</td>
<td>附件表1</td>
<td></td>
</tr>
<tr>
<td>refNum</td>
<td>String</td>
<td>检索参考号</td>
<td>无</td>
<td></td>
</tr>
<tr>
<td>respCode</td>
<td>String</td>
<td>应答码</td>
<td>"00"表示成功</td>
<td></td>
</tr>
<tr>
<td>revAuthCode</td>
<td>String</td>
<td>授权标识应答码</td>
<td>无</td>
<td></td>
</tr>
<tr>
<td>revInsCode</td>
<td>String</td>
<td>附加响应数据</td>
<td>无</td>
<td></td>
</tr>
<tr>
<td>revOrderNum</td>
<td>String</td>
<td>自定义域，用于扫码支付业务。</td>
<td>无</td>
<td></td>
</tr>
<tr>
<td>scanCodeId</td>
<td>String</td>
<td>扫码号</td>
<td>无</td>
<td></td>
</tr>
<tr>
<td>termCode</td>
<td>String</td>
<td>终端号</td>
<td>无</td>
<td></td>
</tr>
<tr>
<td>traceNum</td>
<td>String</td>
<td>受卡方系统跟踪号</td>
<td>合作方交易流水</td>
<td></td>
</tr>
<tr>
<td>transAmt</td>
<td>String</td>
<td>交易金额</td>
<td>无</td>
<td></td>
</tr>
<tr>
<td>transCode</td>
<td>String</td>
<td>交易类型码</td>
<td>无</td>
<td></td>
</tr>
<tr>
<td>transCurr</td>
<td>String</td>
<td>交易货币代码</td>
<td>无</td>
<td></td>
</tr>
<tr>
<td>transDate</td>
<td>String</td>
<td>原交易日期</td>
<td>无</td>
<td></td>
</tr>
<tr>
<td>transDatetime</td>
<td>String</td>
<td>受卡方所在地日期＋受卡方所在地时</td>
<td>无</td>
<td></td>
</tr>
<tr>
<td>transRate</td>
<td>String</td>
<td>持卡人扣帐汇率</td>
<td>无</td>
<td></td>
</tr>
</tbody>
</table></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
